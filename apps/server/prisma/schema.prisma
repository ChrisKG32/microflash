// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

// Enums
enum CardState {
  NEW
  LEARNING
  REVIEW
  RELEARNING
}

enum Rating {
  AGAIN  // Completely forgot
  HARD   // Remembered with difficulty
  GOOD   // Remembered correctly
  EASY   // Remembered effortlessly
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

// Models
model User {
  id                   String   @id @default(cuid())
  clerkId              String   @unique
  pushToken            String?
  notificationsEnabled Boolean  @default(true)

  // Onboarding
  onboardingComplete      Boolean   @default(false)
  notificationsPromptedAt DateTime?

  // Notification Preferences
  quietHoursStart            String?  // HH:MM format (e.g., "22:00")
  quietHoursEnd              String?  // HH:MM format (e.g., "07:00")
  maxNotificationsPerDay     Int      @default(10)
  notificationCooldownMinutes Int     @default(120)
  backlogThreshold           Int      @default(5)
  timezone                   String   @default("UTC")

  // Notification Tracking
  lastPushSentAt           DateTime?
  notificationsCountToday  Int       @default(0)
  notificationsCountThisWeek Int     @default(0)

  // Sprint Preferences
  sprintSize               Int       @default(5)

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  decks   Deck[]
  reviews Review[]
  tags    Tag[]

  @@index([clerkId])
}

model Deck {
  id           String   @id @default(cuid())
  title        String
  description  String?
  priority     Priority @default(MEDIUM)
  parentDeckId String?
  userId       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  parentDeck Deck?  @relation("DeckHierarchy", fields: [parentDeckId], references: [id])
  subDecks   Deck[] @relation("DeckHierarchy")
  cards      Card[]

  @@index([userId])
}

model Card {
  id                   String    @id @default(cuid())
  front                String    @db.Text
  back                 String    @db.Text
  priority             Priority  @default(MEDIUM)

  // FSRS Algorithm State
  stability            Float     @default(0)
  difficulty           Float     @default(0)
  elapsedDays          Int       @default(0)
  scheduledDays        Int       @default(0)
  reps                 Int       @default(0)
  lapses               Int       @default(0)
  state                CardState @default(NEW)
  lastReview           DateTime?

  // Scheduling
  nextReviewDate       DateTime

  // Notification & Snooze
  lastNotificationSent DateTime?
  snoozedUntil         DateTime?

  // Metadata
  deckId               String
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relations
  deck     Deck      @relation(fields: [deckId], references: [id], onDelete: Cascade)
  reviews  Review[]
  cardTags CardTag[]

  @@index([nextReviewDate])
  @@index([deckId])
}

model Review {
  id        String   @id @default(cuid())
  rating    Rating
  userId    String
  cardId    String
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  card Card @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([cardId])
  @@index([createdAt])
}

model Tag {
  id        String   @id @default(cuid())
  name      String
  userId    String
  createdAt DateTime @default(now())

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  cardTags CardTag[]

  @@unique([userId, name])
  @@index([userId])
}

model CardTag {
  id        String   @id @default(cuid())
  cardId    String
  tagId     String
  createdAt DateTime @default(now())

  // Relations
  card Card @relation(fields: [cardId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([cardId, tagId])
  @@index([cardId])
  @@index([tagId])
}