// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

// Enums
enum CardState {
  NEW
  LEARNING
  REVIEW
  RELEARNING
}

enum Rating {
  AGAIN  // Completely forgot
  HARD   // Remembered with difficulty
  GOOD   // Remembered correctly
  EASY   // Remembered effortlessly
}



enum SprintStatus {
  PENDING
  ACTIVE
  COMPLETED
  ABANDONED
}

enum SprintSource {
  HOME   // Started manually from Home screen
  DECK   // Started from Deck Detail screen
  PUSH   // Created by server for push notification
}

enum CardResult {
  PASS
  FAIL
  SKIP
}

// Models
// Relations summary:
// - User: decks, reviews, tags, sprints
// - Deck: user, parentDeck, subDecks, cards, sprints
// - Card: deck, reviews, cardTags, sprintCards
// - Tag: user, cardTags
// - CardTag: card, tag
// - Sprint: user, deck, sprintCards
// - SprintCard: sprint, card
// - Review: user, card

model User {
  id                   String   @id @default(cuid())
  clerkId              String   @unique
  pushToken            String?
  notificationsEnabled Boolean  @default(true)

  // Onboarding
  onboardingComplete      Boolean   @default(false)
  notificationsPromptedAt DateTime?

  // Notification Preferences
  quietHoursStart            String?  // HH:MM format (e.g., "22:00")
  quietHoursEnd              String?  // HH:MM format (e.g., "07:00")
  maxNotificationsPerDay     Int      @default(5)
  notificationCooldownMinutes Int     @default(120)
  backlogThreshold           Int      @default(5)
  timezone                   String   @default("UTC")

  // Notification Tracking
  lastPushSentAt           DateTime?
  notificationsCountToday  Int       @default(0)
  notificationsCountThisWeek Int     @default(0)

  // Sprint Preferences
  sprintSize               Int       @default(5)

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  decks   Deck[]
  reviews Review[]
  tags    Tag[]
  sprints Sprint[]

  @@index([clerkId])
}

model Deck {
  id                  String   @id @default(cuid())
  title               String
  description         String?
  priority            Int      @default(50)
  parentDeckId        String?
  userId              String
  isOnboardingFixture Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  parentDeck Deck?    @relation("DeckHierarchy", fields: [parentDeckId], references: [id])
  subDecks   Deck[]   @relation("DeckHierarchy")
  cards      Card[]
  sprints    Sprint[]

  @@index([userId])
  @@index([isOnboardingFixture])
}

model Card {
  id                   String    @id @default(cuid())
  front                String    @db.Text
  back                 String    @db.Text
  priority             Int       @default(50)

  // FSRS Algorithm State
  stability            Float     @default(0)
  difficulty           Float     @default(0)
  elapsedDays          Int       @default(0)
  scheduledDays        Int       @default(0)
  reps                 Int       @default(0)
  lapses               Int       @default(0)
  state                CardState @default(NEW)
  lastReview           DateTime?

  // Scheduling
  nextReviewDate       DateTime

  // Notification & Snooze
  lastNotificationSent DateTime?
  snoozedUntil         DateTime?

  // Metadata
  deckId               String
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relations
  deck        Deck         @relation(fields: [deckId], references: [id], onDelete: Cascade)
  reviews     Review[]
  cardTags    CardTag[]
  sprintCards SprintCard[]

  @@index([nextReviewDate])
  @@index([deckId])
}

model Review {
  id        String   @id @default(cuid())
  rating    Rating
  userId    String
  cardId    String
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  card Card @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([cardId])
  @@index([createdAt])
}

model Tag {
  id        String   @id @default(cuid())
  name      String
  userId    String
  createdAt DateTime @default(now())

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  cardTags CardTag[]

  @@unique([userId, name])
  @@index([userId])
}

model CardTag {
  id        String   @id @default(cuid())
  cardId    String
  tagId     String
  createdAt DateTime @default(now())

  // Relations
  card Card @relation(fields: [cardId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([cardId, tagId])
  @@index([cardId])
  @@index([tagId])
}

model Sprint {
  id          String       @id @default(cuid())
  userId      String
  deckId      String?      // Optional: constrain sprint to a specific deck
  status      SprintStatus @default(PENDING)
  source      SprintSource @default(HOME)
  createdAt   DateTime     @default(now())
  startedAt   DateTime?
  completedAt DateTime?

  // Resume/abandon lifecycle fields
  // resumableUntil: when the sprint can no longer be resumed (30 min after last activity)
  // abandonedAt: when the sprint was abandoned (auto or explicit)
  resumableUntil DateTime?
  abandonedAt    DateTime?

  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  deck        Deck?        @relation(fields: [deckId], references: [id], onDelete: SetNull)
  sprintCards SprintCard[]

  @@index([userId])
  @@index([deckId])
  @@index([status])
  @@index([resumableUntil])
}

model SprintCard {
  id        String      @id @default(cuid())
  sprintId  String
  cardId    String
  order     Int
  result    CardResult?
  createdAt DateTime    @default(now())

  // Relations
  sprint Sprint @relation(fields: [sprintId], references: [id], onDelete: Cascade)
  card   Card   @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@unique([sprintId, cardId])
  @@unique([sprintId, order])
  @@index([sprintId])
  @@index([cardId])
}