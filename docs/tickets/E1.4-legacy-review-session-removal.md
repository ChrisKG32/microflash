# E1.4 — Legacy "cardIds review-session" Removal Plan

## Goal

Ensure there is **one review concept: Sprint**. Remove/deprecate the legacy `review-session.tsx` route, update push payloads to use `sprintId`, and remove `/api/cards/by-ids` usage for review sessions.

## DoD

- Migration plan documented (this document)
- No MVP tickets depend on `cardIds` review sessions
- Downstream tickets (E2, E3, E4) build exclusively on sprint-based flows

---

## 1. Inventory of Legacy Surface Area

### Client (`apps/client/`)

| File                      | Legacy Usage                                                                                       | Action                                                                          |
| ------------------------- | -------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------- |
| `app/review-session.tsx`  | Entire screen fetches cards by `cardIds` query param, renders review UI                            | **Remove**                                                                      |
| `app/_layout.tsx`         | Stack route `name="review-session"` + notification handler routes to `/review-session?cardIds=...` | **Remove route, update handler**                                                |
| `app/(tabs)/settings.tsx` | Debug test notification uses `cardIds` + `/review-session` URL                                     | **Update to sprint payload**                                                    |
| `lib/api.ts`              | `getCardsByIds(cardIds)` function calls `/api/cards/by-ids`                                        | **Remove** (or keep if needed elsewhere; currently only used by review-session) |

### Server (`apps/server/`)

| File                                                       | Legacy Usage                                                                               | Action                                                                   |
| ---------------------------------------------------------- | ------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------ |
| `src/routes/cards.ts`                                      | `POST /api/cards/by-ids` endpoint                                                          | **Remove**                                                               |
| `src/lib/validation.ts`                                    | `cardIdsSchema` + `CardIdsInput` type                                                      | **Remove** (only used by `/by-ids` and snooze; snooze will use sprintId) |
| `src/services/notification-grouping.ts`                    | `prepareNotificationPayload()` returns `cardIds` array + `/review-session?cardIds=...` URL | **Replace with sprint payload** (E4.2)                                   |
| `src/services/notification-grouping.test.ts`               | Tests assert `cardIds` in payload and `/review-session` URLs                               | **Update tests** (E4.2)                                                  |
| `src/services/__tests__/notification-orchestrator.test.ts` | Tests assert `cardIds` in payload and `/review-session` URLs                               | **Update tests** (E4.2)                                                  |
| `src/routes/notifications.ts`                              | Snooze endpoint accepts `cardIds` array                                                    | **Replace with sprintId** (E4.3)                                         |

---

## 2. Target State (Sprint-Based)

### Push Notification Payload (per E4.2)

```typescript
{
  to: expoPushToken,
  title: "Time for a micro-sprint!",
  body: "X cards ready for review",
  data: {
    type: "sprint",
    sprintId: "sprint-uuid",
    url: "/sprint/sprint-uuid"
  },
  categoryId: "due_cards"
}
```

### Client Notification Handler (per E4.4)

```typescript
// In app/_layout.tsx handleNotificationResponse()
const data = notification.request.content.data as {
  type?: string;
  sprintId?: string;
  url?: string;
};

// Snooze action → call sprint abandon endpoint
if (actionIdentifier === ACTION_SNOOZE_60) {
  if (data.sprintId) {
    await abandonAndSnoozeSprint(data.sprintId);
  }
  return;
}

// Review action or default tap → navigate to sprint
if (
  actionIdentifier === ACTION_REVIEW_NOW ||
  actionIdentifier === DEFAULT_ACTION_IDENTIFIER
) {
  if (data.sprintId) {
    router.push(`/sprint/${data.sprintId}`);
  } else {
    // Fallback to Home (no backwards compatibility for cardIds)
    router.push('/');
  }
}
```

### Routes

- **Remove:** `app/review-session.tsx`
- **Add:** `app/sprint/[id].tsx` (E3.2)
- **Add:** `app/sprint/complete.tsx` (E3.3)

---

## 3. Migration Strategy

**No backwards compatibility.** Old `cardIds` payloads will route to Home.

### Phase A — Build Sprint Infrastructure (E2, E3, E4.1–E4.3)

During E2/E3/E4 work:

1. Implement sprint routes (`/sprint/[id]`, `/sprint/complete`)
2. Implement sprint API endpoints
3. Update notification scheduler to create sprints and emit `sprintId` payloads (E4.2)
4. Update snooze endpoint to accept `sprintId` (E4.3)

### Phase B — Remove Legacy (after E4.2 ships)

Once sprint-based push is working:

1. Remove `app/review-session.tsx`
2. Remove Stack route registration in `app/_layout.tsx`
3. Update notification handler to only handle `sprintId` (fallback to Home)
4. Remove `getCardsByIds` from `lib/api.ts`
5. Remove `POST /api/cards/by-ids` from server
6. Remove `cardIdsSchema` from validation (if no longer needed)
7. Update notification tests to assert sprint payloads

---

## 4. Removal Checklist

### Client Removal

- [ ] Delete `apps/client/app/review-session.tsx`
- [ ] Remove from `apps/client/app/_layout.tsx`:
  - [ ] Stack.Screen `name="review-session"`
  - [ ] `cardIds` handling in `handleNotificationResponse()`
- [ ] Update `apps/client/app/(tabs)/settings.tsx`:
  - [ ] Change test notification payload to use `sprintId` + `/sprint/[id]` URL
- [ ] Remove from `apps/client/lib/api.ts`:
  - [ ] `getCardsByIds()` function

### Server Removal

- [ ] Remove from `apps/server/src/routes/cards.ts`:
  - [ ] `POST /by-ids` route
  - [ ] `cardIdsSchema` import (if unused elsewhere)
- [ ] Remove from `apps/server/src/lib/validation.ts`:
  - [ ] `cardIdsSchema`
  - [ ] `CardIdsInput` type
- [ ] Update `apps/server/src/services/notification-grouping.ts`:
  - [ ] `prepareNotificationPayload()` to return `sprintId` instead of `cardIds`
  - [ ] Remove `/review-session` URL generation
- [ ] Update `apps/server/src/routes/notifications.ts`:
  - [ ] Snooze endpoint to accept `sprintId` instead of `cardIds`
- [ ] Update tests:
  - [ ] `notification-grouping.test.ts` — assert sprint payloads
  - [ ] `notification-orchestrator.test.ts` — assert sprint payloads

---

## 5. Risks & Edge Cases

### Already-Delivered Notifications

Old notifications in the notification center may contain `cardIds` payloads. When tapped:

- **Behavior:** Route to Home (no error, just fallback)
- **Mitigation:** None needed; user can start a fresh sprint from Home

### Snooze Semantics Shift

- **Legacy:** Snooze snoozed individual `cardIds`
- **Sprint:** Snooze abandons the sprint and snoozes remaining cards ≥2h
- **Impact:** More consistent with "snooze means snooze" design principle

### Test Notification in Settings

The debug "Send Test Notification" button currently uses `cardIds`. Must be updated to:

1. Create a test sprint (or use a mock sprintId)
2. Send payload with `sprintId` + `/sprint/[id]` URL

---

## 6. Downstream Ticket Dependencies

The following tickets should **NOT** build on `cardIds` review sessions:

| Ticket                      | Constraint                                    |
| --------------------------- | --------------------------------------------- |
| E2.\* (Sprint system)       | Uses sprint-based APIs exclusively            |
| E3.1 (Navigation)           | No `review-session` route; only `sprint/[id]` |
| E3.2 (Sprint Review)        | Loads sprint by ID, not cardIds               |
| E4.2 (Sprint push)          | Emits `sprintId` payload                      |
| E4.3 (Push snooze)          | Accepts `sprintId`, not `cardIds`             |
| E4.4 (Client push handling) | Routes to `/sprint/[id]`                      |

---

## 7. Timeline

| Phase | Trigger                          | Actions                                      |
| ----- | -------------------------------- | -------------------------------------------- |
| A     | E2/E3/E4 work begins             | Build sprint infrastructure alongside legacy |
| B     | E4.2 ships (sprint push working) | Execute removal checklist                    |

**Note:** Legacy code can coexist during Phase A without blocking sprint development. Phase B cleanup is a single focused task after sprint flows are validated.
